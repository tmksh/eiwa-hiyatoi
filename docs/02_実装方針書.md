# 実装方針書

## 1. 開発環境セットアップ

### 1.1 必要なツール
```bash
# Node.js (v20以上推奨)
node --version  # v20.x.x

# pnpm（推奨パッケージマネージャー）
npm install -g pnpm
```

### 1.2 プロジェクト初期化コマンド
```bash
# Next.js プロジェクト作成
pnpm create next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"

# 追加パッケージインストール
pnpm add @prisma/client next-auth@beta @tanstack/react-table zod react-hook-form @hookform/resolvers date-fns decimal.js

# 開発用パッケージ
pnpm add -D prisma @types/node

# shadcn/ui セットアップ
pnpm dlx shadcn@latest init
pnpm dlx shadcn@latest add button card input label select table badge dialog alert toast tabs form calendar popover command
```

---

## 2. Prisma スキーマ

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====== 会社マスタ ======
model Company {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  overtimeUnit    Int      @default(15)        // 残業計算単位（分）
  roundingMethod  String   @default("floor")   // floor, ceil, round
  restraintRule   Json?                        // 拘束時間ルール
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  vehicleTypes    VehicleType[]
  wageRules       WageRule[]
  workers         Worker[]
  dailyReports    DailyReport[]

  @@map("companies")
}

// ====== 車種マスタ ======
model VehicleType {
  id           String   @id @default(cuid())
  companyId    String
  code         String
  name         String
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company      Company       @relation(fields: [companyId], references: [id])
  wageRules    WageRule[]
  dailyReports DailyReport[]

  @@unique([companyId, code])
  @@map("vehicle_types")
}

// ====== 賃金ルールマスタ ======
model WageRule {
  id                  String    @id @default(cuid())
  companyId           String
  vehicleTypeId       String
  effectiveFrom       DateTime  @db.Date
  effectiveTo         DateTime? @db.Date

  // 基本給関連
  baseDailyWage       Decimal   @db.Decimal(10, 0)
  baseHours           Decimal   @default(8.00) @db.Decimal(4, 2)

  // 残業単価
  overtimeRateNormal  Decimal?  @db.Decimal(10, 0)
  overtimeRateLate    Decimal?  @db.Decimal(10, 0)
  overtimeRateHoliday Decimal?  @db.Decimal(10, 0)

  // 拘束時間関連
  restraintStartHour  Int?
  restraintAllowance  Decimal?  @db.Decimal(10, 0)

  // その他手当
  allowances          Json      @default("{}")

  // メタ
  ruleDescription     String?
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  company             Company     @relation(fields: [companyId], references: [id])
  vehicleType         VehicleType @relation(fields: [vehicleTypeId], references: [id])
  calculations        WageCalculation[]

  @@map("wage_rules")
}

// ====== 作業員マスタ ======
model Worker {
  id               String   @id @default(cuid())
  employeeCode     String   @unique
  name             String
  nameKana         String?
  defaultCompanyId String?
  phone            String?
  notes            String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  defaultCompany   Company?      @relation(fields: [defaultCompanyId], references: [id])
  dailyReports     DailyReport[]

  @@map("workers")
}

// ====== 日報 ======
model DailyReport {
  id                String   @id @default(cuid())
  workDate          DateTime @db.Date
  workerId          String
  companyId         String
  vehicleTypeId     String

  // 時間情報
  startTime         String   // "HH:mm" 形式
  endTime           String   // "HH:mm" 形式
  breakMinutes      Int      @default(60)

  // フラグ
  isHoliday         Boolean  @default(false)
  isNightShift      Boolean  @default(false)

  // 手動調整
  manualAdjustments Json     @default("{}")

  // ステータス
  status            String   @default("draft") // draft, calculated, confirmed, paid
  notes             String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  worker            Worker            @relation(fields: [workerId], references: [id])
  company           Company           @relation(fields: [companyId], references: [id])
  vehicleType       VehicleType       @relation(fields: [vehicleTypeId], references: [id])
  calculations      WageCalculation[]

  @@unique([workDate, workerId])
  @@map("daily_reports")
}

// ====== 計算結果履歴 ======
model WageCalculation {
  id                    String   @id @default(cuid())
  dailyReportId         String
  calculationVersion    Int      @default(1)

  // 適用ルール
  appliedRuleId         String
  appliedRuleSnapshot   Json

  // 時間計算結果
  workMinutes           Int
  overtimeMinutes       Int      @default(0)
  nightMinutes          Int      @default(0)

  // 金額計算結果
  baseWage              Decimal  @db.Decimal(10, 0)
  overtimeWage          Decimal  @default(0) @db.Decimal(10, 0)
  nightWage             Decimal  @default(0) @db.Decimal(10, 0)
  holidayWage           Decimal  @default(0) @db.Decimal(10, 0)
  restraintAllowance    Decimal  @default(0) @db.Decimal(10, 0)
  otherAllowances       Decimal  @default(0) @db.Decimal(10, 0)
  totalWage             Decimal  @db.Decimal(10, 0)

  // 計算詳細
  calculationLog        Json

  // メタ
  isCurrent             Boolean  @default(true)
  calculatedAt          DateTime @default(now())
  calculatedBy          String?

  dailyReport           DailyReport @relation(fields: [dailyReportId], references: [id])
  appliedRule           WageRule    @relation(fields: [appliedRuleId], references: [id])

  @@map("wage_calculations")
}

// ====== ユーザー（認証用） ======
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  passwordHash  String
  role          String   @default("operator") // admin, operator
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
}
```

---

## 3. 賃金計算エンジン詳細設計

### 3.1 ディレクトリ構造
```
src/lib/wage-calculator/
├── index.ts              # エクスポート
├── types.ts              # 型定義
├── calculator.ts         # メイン計算クラス
├── time-utils.ts         # 時間計算ユーティリティ
├── rule-resolver.ts      # ルール解決
└── allowance-calculator.ts  # 手当計算
```

### 3.2 型定義
```typescript
// src/lib/wage-calculator/types.ts

import { Decimal } from 'decimal.js';

export interface TimeRange {
  start: string;  // "HH:mm"
  end: string;    // "HH:mm"
}

export interface WageRuleData {
  id: string;
  companyId: string;
  vehicleTypeId: string;
  baseDailyWage: Decimal;
  baseHours: Decimal;
  overtimeRateNormal: Decimal | null;
  overtimeRateLate: Decimal | null;
  overtimeRateHoliday: Decimal | null;
  restraintStartHour: number | null;
  restraintAllowance: Decimal | null;
  allowances: Record<string, unknown>;
  company: {
    overtimeUnit: number;
    roundingMethod: 'floor' | 'ceil' | 'round';
    restraintRule: RestraintRule | null;
  };
}

export interface RestraintRule {
  type: 'threshold' | 'hourly';
  conditions: RestraintCondition[];
  includesBreak: boolean;
}

export interface RestraintCondition {
  minHours: number;
  maxHours: number | null;
  allowance: number;
}

export interface CalculationInput {
  workDate: Date;
  workerId: string;
  companyId: string;
  vehicleTypeId: string;
  startTime: string;
  endTime: string;
  breakMinutes: number;
  isHoliday: boolean;
  isNightShift: boolean;
  manualAdjustments?: ManualAdjustment[];
}

export interface ManualAdjustment {
  type: 'add' | 'subtract' | 'override';
  field: 'baseWage' | 'overtimeWage' | 'otherAllowances';
  amount: number;
  reason: string;
}

export interface CalculationLogEntry {
  step: string;
  detail?: unknown;
  value?: number;
  unit?: string;
  [key: string]: unknown;
}

export interface CalculationResult {
  workMinutes: number;
  overtimeMinutes: number;
  nightMinutes: number;
  baseWage: Decimal;
  overtimeWage: Decimal;
  nightWage: Decimal;
  holidayWage: Decimal;
  restraintAllowance: Decimal;
  otherAllowances: Decimal;
  totalWage: Decimal;
  calculationLog: CalculationLogEntry[];
  appliedRule: WageRuleData;
}
```

### 3.3 時間計算ユーティリティ
```typescript
// src/lib/wage-calculator/time-utils.ts

/**
 * "HH:mm" 形式の時刻を分に変換
 */
export function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(':').map(Number);
  return hours * 60 + minutes;
}

/**
 * 分を "HH:mm" 形式に変換
 */
export function minutesToTime(minutes: number): string {
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

/**
 * 労働時間を計算（日跨ぎ対応）
 */
export function calculateWorkMinutes(
  startTime: string,
  endTime: string,
  breakMinutes: number
): number {
  let startMinutes = timeToMinutes(startTime);
  let endMinutes = timeToMinutes(endTime);

  // 日跨ぎ対応（退勤が出勤より前の場合、翌日とみなす）
  if (endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }

  const totalMinutes = endMinutes - startMinutes;
  const workMinutes = totalMinutes - breakMinutes;

  return Math.max(0, workMinutes);
}

/**
 * 拘束時間を計算（休憩を含む総時間）
 */
export function calculateRestraintMinutes(
  startTime: string,
  endTime: string
): number {
  let startMinutes = timeToMinutes(startTime);
  let endMinutes = timeToMinutes(endTime);

  if (endMinutes < startMinutes) {
    endMinutes += 24 * 60;
  }

  return endMinutes - startMinutes;
}

/**
 * 深夜時間帯（22:00-05:00）の労働時間を計算
 */
export function calculateNightMinutes(
  startTime: string,
  endTime: string,
  breakMinutes: number
): number {
  const NIGHT_START = 22 * 60; // 22:00
  const NIGHT_END = 5 * 60;    // 05:00

  let start = timeToMinutes(startTime);
  let end = timeToMinutes(endTime);

  if (end < start) {
    end += 24 * 60;
  }

  let nightMinutes = 0;

  // 22:00以降の深夜時間
  if (end > NIGHT_START) {
    const nightStart = Math.max(start, NIGHT_START);
    const nightEnd = Math.min(end, 24 * 60);
    nightMinutes += Math.max(0, nightEnd - nightStart);
  }

  // 翌日05:00までの深夜時間
  if (end > 24 * 60) {
    const earlyMorningEnd = Math.min(end - 24 * 60, NIGHT_END);
    nightMinutes += Math.max(0, earlyMorningEnd);
  }

  // 休憩時間を深夜時間から按分で引く（簡略化）
  const totalWork = end - start;
  const nightRatio = totalWork > 0 ? nightMinutes / totalWork : 0;
  nightMinutes -= Math.floor(breakMinutes * nightRatio);

  return Math.max(0, nightMinutes);
}

/**
 * 残業時間を丸める
 */
export function roundOvertimeMinutes(
  minutes: number,
  unit: number,
  method: 'floor' | 'ceil' | 'round'
): number {
  if (unit <= 0) return minutes;

  switch (method) {
    case 'floor':
      return Math.floor(minutes / unit) * unit;
    case 'ceil':
      return Math.ceil(minutes / unit) * unit;
    case 'round':
      return Math.round(minutes / unit) * unit;
    default:
      return minutes;
  }
}
```

### 3.4 メイン計算クラス
```typescript
// src/lib/wage-calculator/calculator.ts

import { Decimal } from 'decimal.js';
import { prisma } from '@/lib/db';
import {
  CalculationInput,
  CalculationResult,
  CalculationLogEntry,
  WageRuleData,
  RestraintRule,
} from './types';
import {
  calculateWorkMinutes,
  calculateRestraintMinutes,
  calculateNightMinutes,
  roundOvertimeMinutes,
} from './time-utils';

export class WageCalculator {
  /**
   * 該当する賃金ルールを取得
   */
  private async getApplicableRule(
    companyId: string,
    vehicleTypeId: string,
    workDate: Date
  ): Promise<WageRuleData> {
    const rule = await prisma.wageRule.findFirst({
      where: {
        companyId,
        vehicleTypeId,
        isActive: true,
        effectiveFrom: { lte: workDate },
        OR: [
          { effectiveTo: null },
          { effectiveTo: { gte: workDate } },
        ],
      },
      include: {
        company: {
          select: {
            overtimeUnit: true,
            roundingMethod: true,
            restraintRule: true,
          },
        },
      },
      orderBy: { effectiveFrom: 'desc' },
    });

    if (!rule) {
      throw new Error(
        `賃金ルールが見つかりません: 会社=${companyId}, 車種=${vehicleTypeId}, 日付=${workDate.toISOString()}`
      );
    }

    return rule as WageRuleData;
  }

  /**
   * 拘束手当を計算
   */
  private calculateRestraintAllowance(
    restraintMinutes: number,
    rule: RestraintRule | null
  ): Decimal {
    if (!rule || !rule.conditions) {
      return new Decimal(0);
    }

    const restraintHours = restraintMinutes / 60;

    for (const condition of rule.conditions) {
      const minOk = restraintHours >= condition.minHours;
      const maxOk = condition.maxHours === null || restraintHours < condition.maxHours;

      if (minOk && maxOk) {
        return new Decimal(condition.allowance);
      }
    }

    return new Decimal(0);
  }

  /**
   * メイン計算処理
   */
  async calculate(input: CalculationInput): Promise<CalculationResult> {
    const log: CalculationLogEntry[] = [];

    // 1. 該当する賃金ルールを取得
    const rule = await this.getApplicableRule(
      input.companyId,
      input.vehicleTypeId,
      input.workDate
    );
    log.push({
      step: 'ルール取得',
      ruleId: rule.id,
      baseDailyWage: rule.baseDailyWage.toString(),
      baseHours: rule.baseHours.toString(),
    });

    // 2. 実労働時間を計算
    const workMinutes = calculateWorkMinutes(
      input.startTime,
      input.endTime,
      input.breakMinutes
    );
    log.push({
      step: '実労働時間計算',
      startTime: input.startTime,
      endTime: input.endTime,
      breakMinutes: input.breakMinutes,
      workMinutes,
    });

    // 3. 残業時間を計算
    const baseMinutes = new Decimal(rule.baseHours).mul(60).toNumber();
    const rawOvertimeMinutes = Math.max(0, workMinutes - baseMinutes);
    const overtimeMinutes = roundOvertimeMinutes(
      rawOvertimeMinutes,
      rule.company.overtimeUnit,
      rule.company.roundingMethod as 'floor' | 'ceil' | 'round'
    );
    log.push({
      step: '残業時間計算',
      baseMinutes,
      rawOvertimeMinutes,
      overtimeUnit: rule.company.overtimeUnit,
      roundingMethod: rule.company.roundingMethod,
      overtimeMinutes,
    });

    // 4. 深夜時間を計算
    const nightMinutes = input.isNightShift
      ? calculateNightMinutes(input.startTime, input.endTime, input.breakMinutes)
      : 0;
    log.push({ step: '深夜時間計算', nightMinutes });

    // 5. 基本給
    const baseWage = new Decimal(rule.baseDailyWage);
    log.push({ step: '基本給', value: baseWage.toString() });

    // 6. 残業代計算
    let overtimeRate: Decimal;
    if (input.isHoliday && rule.overtimeRateHoliday) {
      overtimeRate = new Decimal(rule.overtimeRateHoliday);
    } else if (input.isNightShift && rule.overtimeRateLate) {
      overtimeRate = new Decimal(rule.overtimeRateLate);
    } else {
      overtimeRate = new Decimal(rule.overtimeRateNormal || 0);
    }

    const overtimeWage = overtimeRate
      .mul(overtimeMinutes)
      .div(60)
      .floor();
    log.push({
      step: '残業代計算',
      overtimeMinutes,
      overtimeRate: overtimeRate.toString(),
      overtimeWage: overtimeWage.toString(),
    });

    // 7. 深夜手当
    const nightRate = new Decimal(rule.overtimeRateLate || 0);
    const nightWage = nightRate
      .mul(nightMinutes)
      .div(60)
      .mul(0.25) // 深夜割増分のみ
      .floor();
    log.push({
      step: '深夜手当計算',
      nightMinutes,
      nightWage: nightWage.toString(),
    });

    // 8. 休日手当（休日の場合、基本給に対して加算）
    const holidayWage = input.isHoliday
      ? baseWage.mul(0.35).floor() // 35%割増
      : new Decimal(0);
    log.push({
      step: '休日手当計算',
      isHoliday: input.isHoliday,
      holidayWage: holidayWage.toString(),
    });

    // 9. 拘束手当
    const restraintMinutes = calculateRestraintMinutes(input.startTime, input.endTime);
    const restraintAllowance = this.calculateRestraintAllowance(
      restraintMinutes,
      rule.company.restraintRule as RestraintRule | null
    );
    log.push({
      step: '拘束手当計算',
      restraintMinutes,
      restraintHours: (restraintMinutes / 60).toFixed(2),
      restraintAllowance: restraintAllowance.toString(),
    });

    // 10. 合計
    const totalWage = baseWage
      .add(overtimeWage)
      .add(nightWage)
      .add(holidayWage)
      .add(restraintAllowance);
    log.push({
      step: '合計計算',
      totalWage: totalWage.toString(),
    });

    return {
      workMinutes,
      overtimeMinutes,
      nightMinutes,
      baseWage,
      overtimeWage,
      nightWage,
      holidayWage,
      restraintAllowance,
      otherAllowances: new Decimal(0),
      totalWage,
      calculationLog: log,
      appliedRule: rule,
    };
  }

  /**
   * 一括計算
   */
  async calculateBatch(
    inputs: CalculationInput[]
  ): Promise<Map<string, CalculationResult | Error>> {
    const results = new Map<string, CalculationResult | Error>();

    // 並列実行（10件ずつ）
    const batchSize = 10;
    for (let i = 0; i < inputs.length; i += batchSize) {
      const batch = inputs.slice(i, i + batchSize);
      const promises = batch.map(async (input) => {
        const key = `${input.workDate.toISOString()}_${input.workerId}`;
        try {
          const result = await this.calculate(input);
          results.set(key, result);
        } catch (error) {
          results.set(key, error as Error);
        }
      });
      await Promise.all(promises);
    }

    return results;
  }
}

// シングルトンインスタンス
export const wageCalculator = new WageCalculator();
```

---

## 4. Server Actions 設計

### 4.1 日報関連
```typescript
// src/app/actions/daily-reports.ts
'use server';

import { prisma } from '@/lib/db';
import { revalidatePath } from 'next/cache';
import { z } from 'zod';

const DailyReportSchema = z.object({
  workDate: z.string().transform((v) => new Date(v)),
  workerId: z.string().cuid(),
  companyId: z.string().cuid(),
  vehicleTypeId: z.string().cuid(),
  startTime: z.string().regex(/^\d{2}:\d{2}$/),
  endTime: z.string().regex(/^\d{2}:\d{2}$/),
  breakMinutes: z.number().int().min(0).default(60),
  isHoliday: z.boolean().default(false),
  isNightShift: z.boolean().default(false),
  notes: z.string().optional(),
});

export async function createDailyReport(formData: FormData) {
  const validated = DailyReportSchema.parse({
    workDate: formData.get('workDate'),
    workerId: formData.get('workerId'),
    companyId: formData.get('companyId'),
    vehicleTypeId: formData.get('vehicleTypeId'),
    startTime: formData.get('startTime'),
    endTime: formData.get('endTime'),
    breakMinutes: Number(formData.get('breakMinutes')),
    isHoliday: formData.get('isHoliday') === 'true',
    isNightShift: formData.get('isNightShift') === 'true',
    notes: formData.get('notes')?.toString(),
  });

  const report = await prisma.dailyReport.create({
    data: validated,
  });

  revalidatePath('/daily-reports');
  return { success: true, data: report };
}

export async function getDailyReports(date: Date) {
  return prisma.dailyReport.findMany({
    where: { workDate: date },
    include: {
      worker: true,
      company: true,
      vehicleType: true,
      calculations: {
        where: { isCurrent: true },
        take: 1,
      },
    },
    orderBy: { worker: { name: 'asc' } },
  });
}
```

### 4.2 計算関連
```typescript
// src/app/actions/calculations.ts
'use server';

import { prisma } from '@/lib/db';
import { wageCalculator } from '@/lib/wage-calculator';
import { revalidatePath } from 'next/cache';

export async function calculateWage(dailyReportId: string) {
  const report = await prisma.dailyReport.findUnique({
    where: { id: dailyReportId },
    include: { company: true, vehicleType: true },
  });

  if (!report) {
    throw new Error('日報が見つかりません');
  }

  // 既存の計算結果を非アクティブに
  await prisma.wageCalculation.updateMany({
    where: { dailyReportId, isCurrent: true },
    data: { isCurrent: false },
  });

  // 新規計算
  const result = await wageCalculator.calculate({
    workDate: report.workDate,
    workerId: report.workerId,
    companyId: report.companyId,
    vehicleTypeId: report.vehicleTypeId,
    startTime: report.startTime,
    endTime: report.endTime,
    breakMinutes: report.breakMinutes,
    isHoliday: report.isHoliday,
    isNightShift: report.isNightShift,
  });

  // 計算結果を保存
  const calculation = await prisma.wageCalculation.create({
    data: {
      dailyReportId,
      appliedRuleId: result.appliedRule.id,
      appliedRuleSnapshot: JSON.parse(JSON.stringify(result.appliedRule)),
      workMinutes: result.workMinutes,
      overtimeMinutes: result.overtimeMinutes,
      nightMinutes: result.nightMinutes,
      baseWage: result.baseWage,
      overtimeWage: result.overtimeWage,
      nightWage: result.nightWage,
      holidayWage: result.holidayWage,
      restraintAllowance: result.restraintAllowance,
      otherAllowances: result.otherAllowances,
      totalWage: result.totalWage,
      calculationLog: result.calculationLog,
      isCurrent: true,
    },
  });

  // 日報ステータス更新
  await prisma.dailyReport.update({
    where: { id: dailyReportId },
    data: { status: 'calculated' },
  });

  revalidatePath('/calculations');
  return { success: true, data: calculation };
}

export async function batchCalculate(date: Date) {
  const reports = await prisma.dailyReport.findMany({
    where: {
      workDate: date,
      status: { in: ['draft', 'calculated'] },
    },
  });

  const results = {
    success: 0,
    failed: 0,
    errors: [] as { reportId: string; error: string }[],
  };

  for (const report of reports) {
    try {
      await calculateWage(report.id);
      results.success++;
    } catch (error) {
      results.failed++;
      results.errors.push({
        reportId: report.id,
        error: error instanceof Error ? error.message : '不明なエラー',
      });
    }
  }

  revalidatePath('/calculations');
  return results;
}
```

---

## 5. UIコンポーネント設計

### 5.1 Tailwind カスタム設定
```typescript
// tailwind.config.ts
import type { Config } from 'tailwindcss';

const config: Config = {
  darkMode: ['class'],
  content: ['./src/**/*.{js,ts,jsx,tsx,mdx}'],
  theme: {
    extend: {
      colors: {
        // プライマリ（イエロー/ゴールド）
        primary: {
          50: '#FFFBEB',
          100: '#FEF3C7',
          200: '#FDE68A',
          300: '#FCD34D',
          400: '#FBBF24',
          500: '#F7C948', // メインカラー
          600: '#D97706',
          700: '#B45309',
          800: '#92400E',
          900: '#78350F',
        },
        // ステータスカラー
        status: {
          draft: '#94A3B8',      // slate-400
          calculated: '#3B82F6', // blue-500
          confirmed: '#22C55E',  // green-500
          paid: '#8B5CF6',       // violet-500
          error: '#EF4444',      // red-500
        },
      },
      fontFamily: {
        sans: ['var(--font-noto-sans-jp)', 'sans-serif'],
      },
    },
  },
  plugins: [require('tailwindcss-animate')],
};

export default config;
```

### 5.2 共通コンポーネント例
```tsx
// src/components/ui/status-badge.tsx
import { cn } from '@/lib/utils';

type Status = 'draft' | 'calculated' | 'confirmed' | 'paid' | 'error';

const statusConfig: Record<Status, { label: string; className: string }> = {
  draft: {
    label: '下書き',
    className: 'bg-slate-100 text-slate-700',
  },
  calculated: {
    label: '計算済',
    className: 'bg-blue-100 text-blue-700',
  },
  confirmed: {
    label: '確定',
    className: 'bg-green-100 text-green-700',
  },
  paid: {
    label: '支払済',
    className: 'bg-violet-100 text-violet-700',
  },
  error: {
    label: 'エラー',
    className: 'bg-red-100 text-red-700',
  },
};

export function StatusBadge({ status }: { status: Status }) {
  const config = statusConfig[status];

  return (
    <span
      className={cn(
        'inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium',
        config.className
      )}
    >
      {config.label}
    </span>
  );
}
```

---

## 6. テスト戦略

### 6.1 単体テスト（計算エンジン）
```typescript
// tests/unit/wage-calculator.test.ts
import { describe, it, expect } from 'vitest';
import {
  calculateWorkMinutes,
  roundOvertimeMinutes,
  calculateNightMinutes,
} from '@/lib/wage-calculator/time-utils';

describe('時間計算ユーティリティ', () => {
  describe('calculateWorkMinutes', () => {
    it('通常の労働時間を正しく計算する', () => {
      expect(calculateWorkMinutes('08:00', '17:00', 60)).toBe(480); // 8時間
    });

    it('日跨ぎの労働時間を正しく計算する', () => {
      expect(calculateWorkMinutes('22:00', '06:00', 60)).toBe(420); // 7時間
    });
  });

  describe('roundOvertimeMinutes', () => {
    it('5分単位で切り捨てる', () => {
      expect(roundOvertimeMinutes(127, 5, 'floor')).toBe(125);
    });

    it('10分単位で切り上げる', () => {
      expect(roundOvertimeMinutes(121, 10, 'ceil')).toBe(130);
    });

    it('15分単位で四捨五入する', () => {
      expect(roundOvertimeMinutes(127, 15, 'round')).toBe(120);
      expect(roundOvertimeMinutes(128, 15, 'round')).toBe(135);
    });
  });
});
```

### 6.2 E2Eテスト
```typescript
// tests/e2e/daily-report.spec.ts
import { test, expect } from '@playwright/test';

test.describe('日報入力', () => {
  test('日報を新規登録できる', async ({ page }) => {
    await page.goto('/daily-reports/new');

    // フォーム入力
    await page.fill('[name="workDate"]', '2024-01-28');
    await page.selectOption('[name="workerId"]', 'worker-1');
    await page.selectOption('[name="companyId"]', 'company-1');
    await page.selectOption('[name="vehicleTypeId"]', 'vehicle-1');
    await page.fill('[name="startTime"]', '08:00');
    await page.fill('[name="endTime"]', '17:00');

    // 保存
    await page.click('button[type="submit"]');

    // 成功メッセージ確認
    await expect(page.locator('.toast-success')).toBeVisible();
  });
});
```

---

## 7. 環境変数設定

```env
# .env.example

# Database
DATABASE_URL="postgresql://user:password@localhost:5432/eiwa_hiyatoi?schema=public"

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key-here"

# App
NEXT_PUBLIC_APP_NAME="永和日雇い管理システム"
```

---

## 8. 開発フロー

### 8.1 Git ブランチ戦略
```
main
 └── develop
      ├── feature/setup-project
      ├── feature/master-crud
      ├── feature/daily-report
      ├── feature/wage-calculator
      └── feature/batch-calculation
```

### 8.2 コミットメッセージ規約
```
feat: 機能追加
fix: バグ修正
docs: ドキュメント
refactor: リファクタリング
test: テスト追加・修正
chore: その他の変更
```
